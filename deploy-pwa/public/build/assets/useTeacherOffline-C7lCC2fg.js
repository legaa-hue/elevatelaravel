import{r as A,Q as a}from"./app-CDJn0Pzk.js";import{u as Q}from"./TeacherLayout-6RngpzKi.js";function W(){const w=A({}),d=A(new Set),f=async(t,n=null,r={})=>{try{w.value[t]={progress:0,status:"downloading"};const o=await fetch(t);if(!o.ok)throw new Error(`Failed to download: ${o.statusText}`);const i=await o.blob(),u=await k(i);return await a.save("fileCache",{url:t,data:u,type:i.type,size:i.size,course_id:n,cached_at:Date.now(),...r}),w.value[t]={progress:100,status:"completed"},d.value.add(t),!0}catch(o){return console.error("File download error:",o),w.value[t]={progress:0,status:"error",error:o.message},!1}},g=async(t,n=null)=>(await Promise.allSettled(t.map(o=>f(o,n)))).map((o,i)=>({url:t[i],success:o.status==="fulfilled"&&o.value,error:o.status==="rejected"?o.reason:null})),y=async t=>{try{const n=await a.get("fileCache",t);if(!n)return null;const r=D(n.data,n.type);return{blob:r,url:URL.createObjectURL(r),type:n.type,size:n.size,cached_at:n.cached_at}}catch(n){return console.error("Error getting cached file:",n),null}},m=async t=>!!await a.get("fileCache",t),_=async(t,n=null)=>{const r=await y(t);return r||(navigator.onLine?(await f(t,n),await y(t)):null)},C=async t=>{if(!t.attachments||t.attachments.length===0)return;const n=t.attachments.map(r=>r.path?`/storage/${r.path}`:r.url||r).filter(Boolean);return await g(n,t.course_id)},v=async t=>{if(!t.attachments||t.attachments.length===0)return;const n=t.attachments.map(r=>r.path?`/storage/${r.path}`:r.url||r).filter(Boolean);return await g(n,t.course_id)},b=async t=>{try{const n=await a.getByIndex("classwork","course_id",t),r=[];for(const u of n)if(u.attachments){const F=u.attachments.map(h=>h.path?`/storage/${h.path}`:h.url||h).filter(Boolean);r.push(...F)}if(r.length===0)return{success:!0,count:0};const o=await g(r,t);return{success:!0,count:o.filter(u=>u.success).length,total:r.length,results:o}}catch(n){return console.error("Error downloading course files:",n),{success:!1,error:n.message}}},S=async(t=30*24*60*60*1e3)=>{try{const n=await a.getAll("fileCache"),r=Date.now();let o=0;for(const i of n)r-i.cached_at>t&&(await a.delete("fileCache",i.url),o++);return{success:!0,deletedCount:o}}catch(n){return console.error("Error clearing old cache:",n),{success:!1,error:n.message}}},O=async()=>{try{const t=await a.getAll("fileCache"),n=t.reduce((o,i)=>o+(i.size||0),0);return{totalFiles:t.length,totalSize:n,totalSizeMB:(n/(1024*1024)).toFixed(2)}}catch(t){return console.error("Error getting cache stats:",t),{totalFiles:0,totalSize:0,totalSizeMB:"0.00"}}},k=t=>new Promise((n,r)=>{const o=new FileReader;o.onloadend=()=>n(o.result),o.onerror=r,o.readAsDataURL(t)}),D=(t,n)=>{const r=atob(t.split(",")[1]),o=new ArrayBuffer(r.length),i=new Uint8Array(o);for(let u=0;u<r.length;u++)i[u]=r.charCodeAt(u);return new Blob([o],{type:n})};return{downloadProgress:w,downloadedFiles:d,downloadFile:f,downloadFiles:g,getCachedFile:y,isFileCached:m,getFile:_,downloadClassworkAttachments:C,downloadSubmissionAttachments:v,downloadCourseFiles:b,clearOldCache:S,getCacheStats:O}}function K(){const{isOnline:w,saveOfflineAction:d,getCachedData:f,cacheData:g}=Q(),{downloadCourseFiles:y}=W(),m=async e=>{await g("dashboardCache",{key:"dashboard",data:e,cached_at:Date.now()})},_=async()=>{const e=await f("dashboardCache","dashboard");return(e==null?void 0:e.data)||null},C=async e=>{const s=`temp_${Date.now()}`,c={...e,id:s,synced:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return await a.save("courses",c),await d("create_course",e),c},v=async(e,s)=>{const c=await a.get("courses",e);if(c){const l={...c,...s,synced:!1,updated_at:new Date().toISOString()};await a.save("courses",l)}return await d("update_course",{id:e,...s}),c},b=async(e=null)=>e?await a.getByIndex("courses","teacher_id",e):await a.getAll("courses"),S=async e=>{await a.saveMany("courses",e)},O=async e=>{const s=`temp_event_${Date.now()}`,c={...e,id:s,synced:!1,created_at:new Date().toISOString()};return await a.save("events",c),await d("create_event",e),c},k=async(e,s)=>{const c=await a.get("events",e);if(c){const l={...c,...s,synced:!1};await a.save("events",l)}return await d("update_event",{id:e,...s}),c},D=async e=>{await a.delete("events",e),await d("delete_event",{id:e})},t=async(e=null)=>e?await a.getByIndex("events","user_id",e):await a.getAll("events"),n=async e=>{await a.saveMany("events",e)},r=async e=>{const s=`temp_classwork_${Date.now()}`,c={...e,id:s,synced:!1,created_at:new Date().toISOString()};return await a.save("classwork",c),await d("create_classwork",e),c},o=async(e,s)=>{const c=await a.get("classwork",e);if(c){const l={...c,...s,synced:!1};await a.save("classwork",l)}return await d("update_classwork",{id:e,...s}),c},i=async(e=null)=>e?await a.getByIndex("classwork","course_id",e):await a.getAll("classwork"),u=async e=>{await a.saveMany("classwork",e)},F=async e=>await r({...e,type:"material"}),h=async e=>await a.getByIndex("materials","course_id",e),M=async e=>{await a.saveMany("materials",e)},x=async(e,s)=>{const c={course_id:e,data:s,synced:!1,updated_at:new Date().toISOString()};return await a.save("gradebooks",c),await d("update_gradebook",{course_id:e,gradebook:s}),c},E=async e=>{const s=await a.get("gradebooks",e);return(s==null?void 0:s.data)||null},z=async(e,s)=>{await a.save("gradebooks",{course_id:e,data:s,synced:!0,updated_at:new Date().toISOString()})},I=async e=>await a.getByIndex("students","course_id",e),U=async(e,s)=>{const c=e.map(l=>({...l,course_id:s}));await a.saveMany("students",c)},$=async(e,s)=>{const c=await a.get("submissions",e);if(c){const l={...c,...s,synced:!1,graded_at:new Date().toISOString()};await a.save("submissions",l)}return await d("grade_submission",{submission_id:e,...s}),c},R=async(e=null)=>e?await a.getByIndex("submissions","classwork_id",e):await a.getAll("submissions"),P=async e=>{await a.saveMany("submissions",e)},L=async(e,s)=>{await a.save("reports",{id:e,type:e,data:s,cached_at:Date.now()})},G=async e=>{const s=await a.get("reports",e);return(s==null?void 0:s.data)||null},T=async()=>(await a.getPendingActions()).length>0,j=async()=>(await a.getPendingActions()).length,B=(e,s=5*60*1e3)=>e?Date.now()-e>s:!0;return{cacheDashboardData:m,getCachedDashboard:_,createCourseOffline:C,updateCourseOffline:v,getCachedCourses:b,cacheCourses:S,createEventOffline:O,updateEventOffline:k,deleteEventOffline:D,getCachedEvents:t,cacheEvents:n,createClassworkOffline:r,updateClassworkOffline:o,getCachedClasswork:i,cacheClasswork:u,createMaterialOffline:F,getCachedMaterials:h,cacheMaterials:M,updateGradebookOffline:x,getCachedGradebook:E,cacheGradebook:z,getCachedStudents:I,cacheStudents:U,gradeSubmissionOffline:$,getCachedSubmissions:R,cacheSubmissions:P,cacheReport:L,getCachedReport:G,hasUnsyncedChanges:T,getUnsyncedCount:j,isDataStale:B,getSmartData:async(e,s,c)=>{if(w.value)try{const p=await e();return p&&c&&await c(p),{data:p,source:"online"}}catch(p){console.warn("Online fetch failed, using cache:",p)}const l=await f(s);return{data:l,source:"cache",stale:B(l==null?void 0:l.cached_at)}},downloadCourseFiles:y}}export{W as a,K as u};
