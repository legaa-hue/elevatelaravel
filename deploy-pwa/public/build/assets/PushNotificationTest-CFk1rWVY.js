import{D as _,r as y,x as T,a as l,b as P,e as s,d as g,h as N,g as h,H as k,t as b,n as C,j as A,F as W,o as c}from"./app-CDJn0Pzk.js";class R{constructor(){this.publicKey=null,this.subscription=null,this.isSupported="serviceWorker"in navigator&&"PushManager"in window}isNotificationSupported(){return this.isSupported}getPermissionStatus(){return this.isSupported?Notification.permission:"unsupported"}async requestPermission(){if(!this.isSupported)throw new Error("Push notifications are not supported in this browser");const n=await Notification.requestPermission();return n==="granted"?(console.log("‚úÖ Notification permission granted"),!0):n==="denied"?(console.log("‚ùå Notification permission denied"),!1):(console.log("‚ö†Ô∏è Notification permission dismissed"),!1)}async fetchPublicKey(){try{const a=await(await fetch("/api/push/public-key")).json();return this.publicKey=a.publicKey.trim(),console.log("üìç Raw VAPID key length:",this.publicKey.length),console.log("üìç VAPID key first 20 chars:",this.publicKey.substring(0,20)),console.log("üìç VAPID key valid format:",/^[A-Za-z0-9_-]+$/.test(this.publicKey)),this.publicKey}catch(n){throw console.error("‚ùå Failed to fetch VAPID public key:",n),n}}urlBase64ToUint8Array(n){const a="=".repeat((4-n.length%4)%4),t=(n+a).replace(/\-/g,"+").replace(/_/g,"/"),i=window.atob(t),r=new Uint8Array(i.length);for(let o=0;o<i.length;++o)r[o]=i.charCodeAt(o);return r}async subscribe(){var n,a;try{if(console.log("üìç Step 1: Checking existing subscription..."),this.subscription)return console.log("‚ÑπÔ∏è Already subscribed to push notifications"),this.subscription;if(console.log("üìç Step 2: Checking permission..."),Notification.permission!=="granted"&&!await this.requestPermission())throw new Error("Notification permission denied");console.log("‚úÖ Permission granted"),console.log("üìç Step 3: Getting service worker...");let t;const i=await navigator.serviceWorker.getRegistration();if(i&&i.active)console.log("‚úÖ Found existing active Service Worker"),t=i;else try{t=await Promise.race([navigator.serviceWorker.ready,new Promise((o,u)=>setTimeout(()=>u(new Error("Service Worker registration timeout after 10 seconds")),1e4))])}catch{if(console.warn("‚ö†Ô∏è Timeout waiting for SW ready, trying getRegistration..."),t=await navigator.serviceWorker.getRegistration(),!t)throw new Error("No Service Worker registration found. Please refresh the page.")}if(console.log("‚úÖ Service worker ready:",(n=t.active)==null?void 0:n.state),!t.active)if(console.warn("‚ö†Ô∏è Service worker not active, waiting..."),t.installing)console.log("‚è≥ Service Worker is installing, waiting for activation..."),await new Promise(o=>{t.installing.addEventListener("statechange",function u(p){p.target.state==="activated"&&(p.target.removeEventListener("statechange",u),console.log("‚úÖ Service worker now active"),o())})});else if(t.waiting)console.log("‚è≥ Service Worker is waiting, trying to activate..."),t.waiting.postMessage({type:"SKIP_WAITING"}),await new Promise(o=>setTimeout(o,1e3));else throw new Error("Service Worker is not active and not installing. Please refresh the page.");console.log("üìç Step 4: Fetching VAPID public key..."),this.publicKey||await this.fetchPublicKey(),console.log("‚úÖ VAPID key fetched:",((a=this.publicKey)==null?void 0:a.substring(0,20))+"..."),console.log("üìç Step 5: Subscribing to push manager..."),console.log("üìç Converting key to Uint8Array...");const r=this.urlBase64ToUint8Array(this.publicKey);return console.log("üìç Converted key length:",r.length,"bytes"),console.log("üìç Converted key sample:",Array.from(r.slice(0,10))),this.subscription=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:r}),console.log("‚úÖ Browser subscription created"),console.log("üìç Step 6: Sending subscription to server..."),await this.sendSubscriptionToServer(this.subscription),console.log("‚úÖ Server subscription saved"),console.log("‚úÖ Successfully subscribed to push notifications"),this.subscription}catch(t){throw console.error("‚ùå Failed to subscribe to push notifications:",t),console.error("Error details:",{name:t.name,message:t.message,stack:t.stack}),t}}async unsubscribe(){try{if(!this.subscription){const n=await navigator.serviceWorker.ready;this.subscription=await n.pushManager.getSubscription()}return this.subscription?(await this.removeSubscriptionFromServer(this.subscription),await this.subscription.unsubscribe(),this.subscription=null,console.log("‚úÖ Successfully unsubscribed from push notifications"),!0):!1}catch(n){throw console.error("‚ùå Failed to unsubscribe from push notifications:",n),n}}async sendSubscriptionToServer(n){var p;console.log("üì§ Sending subscription to server...");const a=localStorage.getItem("jwt_token")||sessionStorage.getItem("jwt_token"),t=(p=document.querySelector('meta[name="csrf-token"]'))==null?void 0:p.getAttribute("content"),i={"Content-Type":"application/json",Accept:"application/json"};a&&(i.Authorization=`Bearer ${a}`,console.log("üîë Using JWT token")),t?(i["X-CSRF-TOKEN"]=t,console.log("üîë Using CSRF token")):console.warn("‚ö†Ô∏è No CSRF token found!");const r={endpoint:n.endpoint,keys:{p256dh:btoa(String.fromCharCode.apply(null,new Uint8Array(n.getKey("p256dh")))),auth:btoa(String.fromCharCode.apply(null,new Uint8Array(n.getKey("auth"))))}};console.log("üì§ Request headers:",i),console.log("üì§ Request payload endpoint:",r.endpoint.substring(0,50)+"...");const o=await fetch("/api/push/subscribe",{method:"POST",headers:i,credentials:"same-origin",body:JSON.stringify(r)});if(console.log("üì• Response status:",o.status,o.statusText),!o.ok){const v=await o.text();console.error("‚ùå Server error response:",v);let f;try{f=JSON.parse(v)}catch{f={message:v}}throw new Error(f.message||`Server error: ${o.status}`)}const u=await o.json();return console.log("‚úÖ Server response:",u),u}async removeSubscriptionFromServer(n){var o;const a=localStorage.getItem("jwt_token")||sessionStorage.getItem("jwt_token"),t=(o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"),i={"Content-Type":"application/json",Accept:"application/json"};a&&(i.Authorization=`Bearer ${a}`),t&&(i["X-CSRF-TOKEN"]=t);const r=await fetch("/api/push/unsubscribe",{method:"POST",headers:i,credentials:"same-origin",body:JSON.stringify({endpoint:n.endpoint})});if(!r.ok){const u=await r.json().catch(()=>({}));throw new Error(u.message||"Failed to remove subscription from server")}return await r.json()}async getSubscription(){if(this.subscription)return this.subscription;if(!this.isSupported)return null;const n=await navigator.serviceWorker.ready;return this.subscription=await n.pushManager.getSubscription(),this.subscription}async sendTestNotification(n="Test Notification",a="This is a test from ElevateGS!"){var p;console.log("üì§ Sending test notification...");const t=localStorage.getItem("jwt_token")||sessionStorage.getItem("jwt_token"),i=(p=document.querySelector('meta[name="csrf-token"]'))==null?void 0:p.getAttribute("content");console.log("üîë Auth tokens:",{hasJWT:!!t,hasCSRF:!!i});const r={"Content-Type":"application/json",Accept:"application/json"};t&&(r.Authorization=`Bearer ${t}`,console.log("üîë Using JWT token")),i?(r["X-CSRF-TOKEN"]=i,console.log("üîë Using CSRF token")):console.warn("‚ö†Ô∏è No CSRF token found!"),console.log("üì§ Request headers:",r);const o=await fetch("/api/push/test",{method:"POST",headers:r,credentials:"same-origin",body:JSON.stringify({title:n,body:a})});if(console.log("üì• Response status:",o.status,o.statusText),!o.ok){const v=await o.json().catch(()=>({}));throw console.error("‚ùå Error response:",v),new Error(v.message||"Failed to send test notification")}const u=await o.json();return console.log("‚úÖ Test notification sent successfully:",u),u}}const m=new R,E={class:"min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8"},K={class:"max-w-3xl mx-auto"},F={class:"bg-white rounded-lg shadow-lg p-8"},j={key:0,class:"mb-6 p-4 bg-green-50 border border-green-200 rounded-lg"},I={class:"flex items-center"},D={class:"font-medium text-green-900"},q={class:"text-sm text-green-700"},U={key:1,class:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg"},V={class:"mb-8 space-y-4"},B={class:"grid grid-cols-2 gap-4"},O={class:"p-4 bg-gray-50 rounded"},$={class:"text-lg font-medium"},J={key:0,class:"text-green-600"},M={key:1,class:"text-red-600"},z={class:"p-4 bg-gray-50 rounded"},G={class:"text-lg font-medium"},L={key:0,class:"text-green-600"},H={key:1,class:"text-red-600"},X={key:2,class:"text-yellow-600"},Y={key:3,class:"text-gray-600"},Z={class:"p-4 bg-gray-50 rounded"},Q={class:"text-lg font-medium"},ee={key:0,class:"text-green-600"},se={key:1,class:"text-gray-600"},te={class:"p-4 bg-gray-50 rounded"},oe={class:"text-lg font-medium"},ie={key:0,class:"text-green-600"},re={key:1,class:"text-gray-600"},ne={class:"space-y-4"},ae={class:"p-4 border rounded-lg"},le=["disabled"],ce={class:"p-4 border rounded-lg"},ue=["disabled"],de={key:0,class:"mt-2 text-sm text-red-600"},ge={class:"p-4 border rounded-lg"},pe=["disabled"],be={key:0,class:"mt-2 text-sm text-red-600"},ve={class:"p-4 border border-red-200 rounded-lg"},me=["disabled"],fe={key:3,class:"mt-8 p-4 bg-gray-50 rounded-lg"},he={class:"text-xs font-mono overflow-auto"},ye={class:"mb-2"},Se={class:"break-all text-gray-600"},we={class:"mt-8 p-4 bg-blue-50 border-l-4 border-blue-500 rounded"},ke={class:"text-sm text-blue-800 space-y-1 list-decimal list-inside"},xe={key:0,class:"font-bold text-red-600"},Te={__name:"PushNotificationTest",setup(x){var w;const a=(w=_().props.auth)==null?void 0:w.user,t=y({supported:!1,permission:"default",subscribed:!1,subscription:null,vapidKey:null}),i=y(!1),r=y(""),o=y("info"),u=async()=>{var d;if(t.value.supported=m.isNotificationSupported(),t.value.permission=m.getPermissionStatus(),t.value.supported){const e=await m.getSubscription();t.value.subscribed=!!e,t.value.subscription=e}if("serviceWorker"in navigator){const e=await navigator.serviceWorker.getRegistration();console.log("üîç Service Worker Registration:",e),console.log("üîç SW State:",(d=e==null?void 0:e.active)==null?void 0:d.state),console.log("üîç SW Installing:",e==null?void 0:e.installing),console.log("üîç SW Waiting:",e==null?void 0:e.waiting),console.log("üîç SW Active:",e==null?void 0:e.active)}},p=async()=>{i.value=!0,r.value="";try{await m.requestPermission()?(r.value="Permission granted! ‚úÖ",o.value="success",await u()):(r.value="Permission denied ‚ùå",o.value="error")}catch(d){r.value=`Error: ${d.message}`,o.value="error"}finally{i.value=!1}},v=async()=>{i.value=!0,r.value="";try{console.log("üîÑ Starting subscription process..."),await m.subscribe(),r.value="Successfully subscribed to push notifications! üéâ",o.value="success",await u()}catch(d){console.error("‚ùå Subscription error:",d),r.value=`Subscription failed: ${d.message}`,o.value="error",(d.message.includes("401")||d.message.includes("Unauthorized"))&&(r.value="Authentication failed. Please refresh the page and login again.")}finally{i.value=!1}},f=async()=>{i.value=!0,r.value="";try{await m.unsubscribe(),r.value="Successfully unsubscribed from push notifications",o.value="success",await u()}catch(d){r.value=`Unsubscribe failed: ${d.message}`,o.value="error"}finally{i.value=!1}},S=async()=>{i.value=!0,r.value="";try{await m.sendTestNotification("Test Notification","This is a test push notification from ElevateGS! üöÄ"),r.value="Test notification sent! Check your notifications.",o.value="success"}catch(d){r.value=`Test failed: ${d.message}`,o.value="error"}finally{i.value=!1}};return T(()=>{u()}),(d,e)=>(c(),l(W,null,[P(g(N),{title:"Push Notification Test"}),s("div",E,[s("div",K,[s("div",F,[e[25]||(e[25]=s("h1",{class:"text-3xl font-bold text-gray-900 mb-8"},"Push Notification Test",-1)),g(a)?(c(),l("div",j,[s("div",I,[e[0]||(e[0]=s("span",{class:"text-green-600 mr-2"},"‚úÖ",-1)),s("div",null,[s("div",D,"Logged in as "+b(g(a).name),1),s("div",q,b(g(a).email)+" ("+b(g(a).role)+")",1)])])])):(c(),l("div",U,[...e[1]||(e[1]=[k('<div class="flex items-center"><span class="text-red-600 mr-2">‚ùå</span><div><div class="font-medium text-red-900">Not logged in</div><div class="text-sm text-red-700"> Please <a href="/login" class="underline">login</a> to test push notifications </div></div></div>',1)])])),s("div",V,[e[6]||(e[6]=s("h2",{class:"text-xl font-semibold mb-4"},"Current Status",-1)),s("div",B,[s("div",O,[e[2]||(e[2]=s("div",{class:"text-sm text-gray-600"},"Browser Support",-1)),s("div",$,[t.value.supported?(c(),l("span",J,"‚úÖ Supported")):(c(),l("span",M,"‚ùå Not Supported"))])]),s("div",z,[e[3]||(e[3]=s("div",{class:"text-sm text-gray-600"},"Permission",-1)),s("div",G,[t.value.permission==="granted"?(c(),l("span",L,"‚úÖ Granted")):t.value.permission==="denied"?(c(),l("span",H,"‚ùå Denied")):t.value.permission==="default"?(c(),l("span",X,"‚ö†Ô∏è Not Asked")):(c(),l("span",Y,b(t.value.permission),1))])]),s("div",Z,[e[4]||(e[4]=s("div",{class:"text-sm text-gray-600"},"Subscription Status",-1)),s("div",Q,[t.value.subscribed?(c(),l("span",ee,"‚úÖ Subscribed")):(c(),l("span",se,"‚ùå Not Subscribed"))])]),s("div",te,[e[5]||(e[5]=s("div",{class:"text-sm text-gray-600"},"Can Test",-1)),s("div",oe,[t.value.subscribed?(c(),l("span",ie,"‚úÖ Ready")):(c(),l("span",re,"‚ùå Subscribe First"))])])])]),r.value?(c(),l("div",{key:2,class:C(["mb-6 p-4 rounded-lg",{"bg-blue-50 border border-blue-200 text-blue-800":o.value==="info","bg-green-50 border border-green-200 text-green-800":o.value==="success","bg-red-50 border border-red-200 text-red-800":o.value==="error"}])},b(r.value),3)):h("",!0),s("div",ne,[e[15]||(e[15]=s("h2",{class:"text-xl font-semibold mb-4"},"Actions",-1)),s("div",ae,[e[7]||(e[7]=s("h3",{class:"font-medium mb-2"},"Step 1: Request Permission",-1)),e[8]||(e[8]=s("p",{class:"text-sm text-gray-600 mb-3"},"Ask user for notification permission",-1)),s("button",{onClick:p,disabled:i.value||!t.value.supported||t.value.permission==="granted",class:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"},b(i.value?"Processing...":"Request Permission"),9,le)]),s("div",ce,[e[9]||(e[9]=s("h3",{class:"font-medium mb-2"},"Step 2: Subscribe to Push",-1)),e[10]||(e[10]=s("p",{class:"text-sm text-gray-600 mb-3"},"Subscribe to receive push notifications",-1)),s("button",{onClick:v,disabled:i.value||!g(a)||!t.value.supported||t.value.permission!=="granted"||t.value.subscribed,class:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"},b(i.value?"Processing...":"Subscribe"),9,ue),g(a)?h("",!0):(c(),l("div",de," ‚ö†Ô∏è You must be logged in to subscribe "))]),s("div",ge,[e[11]||(e[11]=s("h3",{class:"font-medium mb-2"},"Step 3: Send Test Notification",-1)),e[12]||(e[12]=s("p",{class:"text-sm text-gray-600 mb-3"},"Send a test push notification to yourself",-1)),s("button",{onClick:S,disabled:i.value||!g(a)||!t.value.subscribed,class:"px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"},b(i.value?"Sending...":"Send Test Notification"),9,pe),g(a)?h("",!0):(c(),l("div",be," ‚ö†Ô∏è You must be logged in to send notifications "))]),s("div",ve,[e[13]||(e[13]=s("h3",{class:"font-medium mb-2"},"Unsubscribe",-1)),e[14]||(e[14]=s("p",{class:"text-sm text-gray-600 mb-3"},"Remove push notification subscription",-1)),s("button",{onClick:f,disabled:i.value||!g(a)||!t.value.subscribed,class:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"},b(i.value?"Processing...":"Unsubscribe"),9,me)])]),t.value.subscription?(c(),l("div",fe,[e[17]||(e[17]=s("h3",{class:"font-medium mb-2"},"Subscription Details",-1)),s("div",he,[s("div",ye,[e[16]||(e[16]=s("strong",null,"Endpoint:",-1)),s("div",Se,b(t.value.subscription.endpoint),1)])])])):h("",!0),s("div",we,[e[24]||(e[24]=s("h3",{class:"font-medium text-blue-900 mb-2"},"üìù Testing Instructions",-1)),s("ol",ke,[g(a)?h("",!0):(c(),l("li",xe,[...e[18]||(e[18]=[A("Login first at ",-1),s("a",{href:"/login",class:"underline"},"/login",-1)])])),e[19]||(e[19]=s("li",null,'Click "Request Permission" and allow notifications',-1)),e[20]||(e[20]=s("li",null,'Click "Subscribe" to register for push notifications',-1)),e[21]||(e[21]=s("li",null,'Click "Send Test Notification" to receive a test push',-1)),e[22]||(e[22]=s("li",null,"Check your browser's notification area",-1)),e[23]||(e[23]=s("li",null,"Click the notification to test the click handler",-1))])]),e[26]||(e[26]=k('<div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded"><h3 class="font-medium text-yellow-900 mb-2">‚ö†Ô∏è Troubleshooting</h3><ul class="text-sm text-yellow-800 space-y-1 list-disc list-inside"><li>Make sure VAPID keys are set in .env</li><li>Check browser console for errors</li><li>Ensure you&#39;re on HTTPS or localhost</li><li>Service Worker must be registered</li><li>Check if notifications are blocked in browser settings</li></ul></div><div class="mt-8"><a href="/" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 inline-block"> ‚Üê Back to Home </a></div>',2))])])])],64))}};export{Te as default};
